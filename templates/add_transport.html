{% extends "base.html" %} {% block title %}Add New Transport | AgriTransport{%
endblock %} {% block content %}
<div class="py-6">
  <!-- Authentication Check - This section will show if user is not logged in -->
  <div id="not-authenticated" class="hidden">
    <div class="text-center py-12">
      <i class="fas fa-lock text-5xl text-gray-300 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        Authentication Required
      </h2>
      <p class="text-gray-600 mb-6">
        You need to be logged in to add transports.
      </p>
      <div class="flex justify-center space-x-4">
        <a
          href="/login"
          class="bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-6 rounded-lg transition"
        >
          Login
        </a>
        <a
          href="/register"
          class="border border-primary text-primary hover:bg-primary/5 font-semibold py-2 px-6 rounded-lg transition"
        >
          Register
        </a>
      </div>
    </div>
  </div>

  <!-- Main content - Only visible when authenticated -->
  <div id="authenticated-content">
    <div class="flex items-center mb-8">
      <a
        href="/my-transports"
        class="text-primary hover:underline inline-flex items-center mr-4"
      >
        <i class="fas fa-arrow-left mr-2"></i>
        Back to My Transports
      </a>
      <h1 class="text-3xl font-bold text-gray-800">Add New Transport</h1>
    </div>

    <div
      id="error-container"
      class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-6 hidden"
    >
      <span id="error-message"></span>
    </div>

    <form
      id="addTransportForm"
      class="bg-white rounded-lg shadow-md p-6 max-w-3xl"
    >
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Basic Information -->
        <div class="md:col-span-2">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Basic Information
          </h2>
        </div>

        <!-- Form needs enctype for file uploads -->
        <script>
          document
            .getElementById("addTransportForm")
            .setAttribute("enctype", "multipart/form-data");
        </script>

        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1"
            >Transport Name</label
          >
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
        </div>

        <div>
          <label
            for="category"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Category</label
          >
          <select
            id="category"
            name="category"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          >
            <option value="">Select a category</option>
            <option value="tractor">Tractor</option>
            <option value="harvester">Harvester</option>
            <option value="truck">Truck</option>
            <option value="seeder">Seeder</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label
            for="location"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Location</label
          >
          <select
            id="location"
            name="location"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          >
            <option value="">Select a location</option>
            <option value="taldykorgan">Taldykorgan</option>
            <option value="almaty">Almaty</option>
            <option value="astana">Astana</option>
            <option value="shymkent">Shymkent</option>
            <option value="atyrau">Atyrau</option>
          </select>
        </div>

        <div>
          <label
            for="price_per_day"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Price per Day ($)</label
          >
          <input
            type="number"
            id="price_per_day"
            name="price_per_day"
            min="1"
            step="0.01"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
        </div>

        <div class="md:col-span-2">
          <label
            for="description"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Description</label
          >
          <textarea
            id="description"
            name="description"
            rows="4"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          ></textarea>
        </div>

        <!-- Specifications -->
        <div class="md:col-span-2 border-t pt-6 mt-2">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Specifications
          </h2>
        </div>

        <div>
          <label for="year" class="block text-sm font-medium text-gray-700 mb-1"
            >Year</label
          >
          <input
            type="number"
            id="year"
            name="year"
            min="1900"
            max="2099"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
        </div>

        <div>
          <label
            for="model"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Model</label
          >
          <input
            type="text"
            id="model"
            name="model"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
        </div>

        <div>
          <label
            for="capacity"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Capacity</label
          >
          <input
            type="text"
            id="capacity"
            name="capacity"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
        </div>

        <div>
          <label
            for="image"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Transport Image</label
          >
          <input
            type="file"
            id="image"
            name="image"
            accept="image/*"
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary transition"
          />
          <p class="text-xs text-gray-500 mt-1">
            Upload an image of your transport (max size: 5MB)
          </p>
        </div>

        <div class="md:col-span-2 border-t pt-6 flex justify-end">
          <button
            type="submit"
            class="bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg transition"
          >
            Add Transport
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Check authentication state
  document.addEventListener("DOMContentLoaded", function () {
    if (!auth.isLoggedIn()) {
      // Show not authenticated message
      document.getElementById("not-authenticated").classList.remove("hidden");
      document.getElementById("authenticated-content").classList.add("hidden");
    }
  });

  document
    .getElementById("addTransportForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const errorContainer = document.getElementById("error-container");
      const errorMessage = document.getElementById("error-message");

      // Hide any previous error
      errorContainer.classList.add("hidden");

      // Create FormData object for file upload
      const formData = new FormData();
      formData.append("name", document.getElementById("name").value);
      formData.append("category", document.getElementById("category").value);
      formData.append("location", document.getElementById("location").value);
      formData.append(
        "price_per_day",
        document.getElementById("price_per_day").value
      );
      formData.append(
        "description",
        document.getElementById("description").value
      );

      // Optional fields
      if (document.getElementById("year").value) {
        formData.append("year", document.getElementById("year").value);
      }

      if (document.getElementById("model").value) {
        formData.append("model", document.getElementById("model").value);
      }

      if (document.getElementById("capacity").value) {
        formData.append("capacity", document.getElementById("capacity").value);
      }

      // Image file
      const imageFile = document.getElementById("image").files[0];
      if (imageFile) {
        formData.append("image", imageFile);
      }

      try {
        const response = await authFetch("/api/transports/", {
          method: "POST",
          body: formData, // No Content-Type header - browser sets it with boundary
        });

        if (response && response.ok) {
          const data = await response.json();

          // Show success message
          const successDiv = document.createElement("div");
          successDiv.className =
            "bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md mb-6";
          successDiv.textContent =
            "Transport added successfully! Redirecting...";

          const form = document.getElementById("addTransportForm");
          form.parentNode.insertBefore(successDiv, form);

          // Redirect to my transports page
          setTimeout(() => {
            window.location.href = "/my-transports?added=true";
          }, 1000);
        } else if (response) {
          // Show error message
          let message = "Failed to add transport.";
          try {
            const errorData = await response.json();
            if (errorData.detail) {
              message = errorData.detail;
            }
          } catch (e) {
            console.error("Error parsing response:", e);
          }

          errorMessage.textContent = message;
          errorContainer.classList.remove("hidden");
        }
      } catch (error) {
        console.error("Add transport error:", error);
        errorMessage.textContent =
          "An error occurred while adding the transport. Please try again.";
        errorContainer.classList.remove("hidden");
      }
    });
</script>
{% endblock %}
